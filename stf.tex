\input{preface}

\section{The Angular Transfer Function of the BGPS} 


\subsection{Atmosphere Tests}
\label{sec:atmotests}
In order to determine the angular response of the Bolocam array and BGPS
pipeline in realistic observing conditions, we performed simulations of a
plausible synthetic astrophysical sky with synthetic atmospheric signal added
to the timestream.

To generate the simulated atmosphere, we fit a piecewise power law to a power
spectrum of a raw observed timestream.  The power spectrum varies in amplitude significantly
depending on weather conditions and observation length, but the shape is
generally well-represented by $P\propto \nu^{-2}$ for $\nu < 2 $ Hz and $P \propto \nu^{-1} $
for $\nu \geq 2$ Hz where $\nu$ is the frequency.  
We show a fitted timestream power spectrum in Figure \ref{fig:powerspecfit}.

%\optional{
%At low frequencies, the power spectrum turns over because of the AC sampler 
%(offset from the DC value, not the total power, is the measured value).
%Despite the break, we use the low-frequency power fit to represent the AC
%sampling.
%}


\Figure{{figures/050706_o53_raw_ds2.nc_indiv13pca_PowerSpectrumFit}.png}
{Fit to the power spectrum of a $\sim30$ minute observation.  Three independent power
laws are fit to the data,  with a fixed break at 0.02 Hz (below which the AC sampler
removes signal) and a fitted break at
higher frequency, near 2 Hz, where the power spectrum flattens towards white noise.  
%The Y-axis indicates the spectral power in units of Jy$^2$ for a single beam; the
%power spectra were taken on the calibrated data
}
{fig:powerspecfit}{0.5}{0}


%Variations
%upon these atmospheric parameters were not investigated in detail, but in the
%limit that the atmosphere is perfectly correlated across the array, the details
%of the atmospheric behavior should not affect the pipeline's performance.

The Fourier transform of the atmosphere timestream is generated by applying noise
to the fitted power spectrum.  The power at each frequency is multiplied by a
random number sampled from a gaussian distribution with width 1.2, determined
to be a reasonable match to the data, and mean 1.0.
The resulting Fourier-transformed timestream is $FT(ts) = (r_{\nu1} P_f)^{1/2} + i
(r_{\nu2} P_f)^{1/2}$, where $r_1$ and $r_2$ are the normally distributed random
variables and $P_f$ is the fitted power-law power spectrum.
The atmosphere timestream is then created by inverse Fourier transforming 
this signal.


% I don't know why this is right, but I think it is: see
% PowerSpectrumStuff.ipynb

Gaussian noise is added to the atmospheric timestream of each bolometer
independently, which renders the correlation between timestreams imperfect.
The noise level set in the individual timestreams sets the noise level in the
output map.


\subsubsection{Simulated Map Parameters}
We simulated the astrophysical sky by
randomly sampling signal from a circularly symmetric 2D power-law distribution in Fourier space.  We
modeled this signal using power spectrum power-law indices ranging from -3 to
+0.5; in the HiGal $\ell=30$ SDP field, the power-law index measured from the
500 \um\ map is $\alpha\sim-2$ (see Section \ref{sec:otherdata}).
The data were smoothed with a model of the instrument PSF to simulate the
telescope's aperture and illumination pattern.  
For each power-law index, four realizations of the map using different random seeds
were created.  
The signal map was then sampled into timestreams with the Bolocam array using
a standard pair of perpendicular boustrophedonic scan patterns.  
Examples of one of these realizations with identical random numbers and
different power laws are shown in Figure \ref{fig:exp10gridin}.

\FigureTwo{figures/exp10_input_grid}{figures/exp10_recovered_grid}
{Examples of input (left) and output (right) maps for different power law $\alpha$ values.
For very steep power laws, most of the power is on the largest scales.  
$\alpha=0$ is white noise.  The axis scales are in pixels, where each pixel
is 7.2\arcsec, so each field is approximately 1\arcdeg\ on a side.  The Bolocam
footprint is plotted in the lower-right panel of the left figure as an
indication of the largest possible recovered angular scales.  The input images are
normalized to have the same \emph{peak} flux density.
The pipeline recovers no emission from the simulation with $\alpha=3$, but this
value of $\alpha$ is not representative of the real astrophysical sky -
Herschel sees structure with $\alpha\lesssim2$, and the BGPS detected a great
deal of astrophysical signal (see Section \ref{sec:otherdata} and Figure
\ref{fig:higalpowerlaw}).
}
{fig:exp10gridin}{1}

% We found that all power-law indices returned broadly consistent results, but
% the steeper indices had no signal recovery at small spatial scales because of
% low signal-to-noise ratio (i.e., the selected normalization put all recoverable
% structure below the observational noise level).  Example recovered images as a function of $\alpha$
% are shown in figure \ref{fig:exp10gridout}.  We therefore only used the
% simulations with moderate power-law indices ($-2 < \alpha < -1$) for
% quantitative analysis.

% \Figure{figures/exp10_recovered_grid}
% {Examples of the recovered maps for different power law $\alpha$ values.
% For the steepest power-law, most of the flux above the noise level is lost. }
% {fig:exp10gridout}{0.5}{0}


%If the
%data are downsampled, a filter of the form $f(\nu) = 2/ (1+(\nu/\nu_0)^3)$ is
%applied (multiplied by $FT(ts)$) at this point.  If it is applied, it is
%deconvolved after downsampling.

% Not needed to understand section, therefore excluded
% Because the bolometers have different gains, the atmosphere timestream is
% multiplicatively scaled by a random value sampled from a normal distribution
% with mean 1 and width 0.4 (which approximately matches the true gain
% distribution).  This step is included to test the gain correction performed
% (non-iteratively) in the pipeline.  The gain correction is performed
% independently for each observation.

% Removed because I think this is effectively included already.  Also, I think
% the 'gains' are applied AFTER that atmosphere is added (wouldn't really make sense otherwise)
%After the relative scales are applied, the atmosphere timestream for all
%bolometers is scaled by a specified amplitude to make the atmosphere amplitude
%greater than or comparable to the astrophysical signal amplitude.

% This noise should
% represent a combination of uncorrelated electronic noise and optical noise from
% the observed light.  It is responsible for setting the final noise level in the
% output map.

% \Figure{figures/airy_test_ds2_reconv_arrang45_atmotest_varyrelscale_amp1.0E+01_pointcompare.png}%exp2_varyrelscale_amp1E+01_map20_ds2inputcompare_point}
% {Example point source (Airy function) simulation with atmosphere.  The top panel shows radial
% profiles of the input and pipeline-reduced (ds2 indicating downsampling by a factor of 2)
% maps.  The bottom panels show the maps as labeled.  The black circle is the
% fitted circular Gaussian FWHM .  This simulation uses atmospheric noise with an
% amplitude $10\times$ the peak amplitude of the input source, typical of a calibrator
% observation. \todo{Remove extraneous text.  Remove titles}
% %The gaussian
% %noise added has an RMS equal to the peak amplitude of the input source.  The
% %flux recovery fraction (within the first Airy null) is 92.7\%.
% %For both the
% %input map and the pipeline-recovered map, the gaussian fit overpredicts both
% %the peak of the Airy and the wings and underpredicts the intermediate region.
% }
% {fig:pointatmosim2}{0.5}{0}



% \todo{Experiments:}
% - nu^-1.5, nu^-2 power spectra inputs - examine how sensitive pipeline is to input power
% - vary as a function of astrophysical:atmospheric power
% - Determine relative power: measure l=30, l=1 astro/atmo ratio
%     - run simulations on that basis
%     - then run simulations based on l=65
%     - 3-5 realizations for each

\subsection{The Angular Transfer Function}
\label{sec:STF}
% We measure the spatial transfer function of Bolocam and the BGPS pipeline using
% a series of simulations.  We generated artifical sky maps assuming a power-law
% distribution in the angular azimuthally averaged power spectrum.
% We created a
% power-spectral-density map for a small range of assumed power-law $\alpha = -1,
% -1.5, $ and $-2$  and took the inverse fourier transform of its square root to
% generate the artifical sky map.
% %We
% %then multiplied the resulting map by a Gaussian $\sigma=0.25 \degree$  in the Y-direction to
% %impose Galactic-plane-like structure onto the map.
% Realistic atmospheric noise was added to the maps as described in \todo{Section
% \ref{sec:atmotests}}, and the data were reduced in the same process as the real
% data.

We used a subset of these power-law simulations to measure the amount of recovered signal at each
angular (spatial) scale.
For each power-law in the range $2<\alpha<1$, which best match the Herschel 500
\um power-spectra, we used five different realizations of the map to measure
the angular transfer function, defined as $STF(f) = F_{out}(f)/F_{in}(f)$ where
$f$ is the angular frequency, $F_{out}$ is the azimuthally averaged
power-spectrum of the pipeline-processed map, and $F_{in}$ is the azimuthally
averaged power-spectrum of the simulated input map.

% The spatial transfer function cannot be applied to any simulated map to derive an
% ``observed'' map without putting it through the pipeline.  Applying
% the function incurs a loss of information, and it is therefore not invertible.

% we explored the range 1e-4 - 1e-2 ish
The angular transfer function shows only weak dependence on the ratio of
astrophysical to atmospheric power, and is approximately constant at $\sim95\%$
recovery over the range of angular scales between the beam size and
$\sim2\arcmin$.  The angular transfer fucntion is shown in Figure \ref{fig:stf}.  At larger angular scales, in the range $2\arcmin-8\arcmin$ the
recovery is generally low.  Our simulations included the full
range of observed astrophysical to atmospheric flux density ratios, from $\sim10^{-2}$
for the Central Molecular Zone (CMZ) down to $\sim10^{-4}$ for sparsely
populated regions in the $\ell\sim70$ region.

\Figure{{figures/STF00_no_0.0001}}
{The angular transfer function over the range of angular scales where the BGPS
data are reliable after 20 iterations (blue) and without iterative mapping (red dashed).
At higher angular %The BGPS uses 7.2\arcsec\ pixels.  
frequency (smaller angular scale), the beam smooths out any signal.  At larger
angular frequency, the atmospheric subtraction removes signal. 
The benefits of iterative mapping in recovered flux density on all scales, but
particularly the improvement in large-scale recovery, are evident.
}
{fig:stf}{0.5}{0}

\citet{Chapin2013a} perform a similar analysis for the SCUBA-2 pipeline.  Our
transfer function (Figure \ref{fig:stf}) cuts off at a scale $\sim 1/6$ the
SCUBA-2 scale.  While the angular extent of the Bolocam
footprint is only slightly smaller than SCUBA's, some feature of the instrument
or pipeline allows SCUBA-2 to recover larger angular scales.  We speculate that
the much larger number of bolometers in the SCUBA-2 array allows the atmosphere
to be more reliably separated from astrophysical and internal electrical
signals, so the SCUBA-2 pipeline is able to run with an atmosphere subtraction
algorithm less aggressive than the 13-PCA approach we adopted.


%the much greater sensitivity
%and denser packing of bolometers significantly enhances their ability to
%separate astrophysical and atmospheric signals.

% a higher atmospheric sky amplitude
% can result in a greater apparent recovery fraction because some atmospheric
% flux is being included in the final map at these largest scales; the data are
% not reliable over scales larger than $\sim120\arcsec$ (Figure
% \ref{fig:bestmodels}).  The recovered power does not go to zero because of the 
% iterative process used to remove negative bowls; in this sense, the pipeline
% behaves similar to the interferometric {\sc CLEAN} algorithm.

% not really true
% For point sources, however, the spatial transfer function is nearly perfect;
% point sources have power at all spatial scales that is recovered at nearly
% 100\% at all scales (Figure \ref{fig:pointsourcestf}).

\subsection{Comparison with other data sets}
\label{sec:otherdata}
Given an understanding of the spatial transfer function, it is possible to
compare the BGPS to other surveys, e.g.  Hi-Gal, ATLASGAL, and the JPS, for
temperature and beta measurements.

Because the systematic uncertainties in temperature/beta derivation from dust
SEDs are severe \citep[e.g.][]{Shetty2009a,Shetty2009b,Kelly2012a}, we
recommend a conservative approach when comparing BGPS data with other data
sets. 
For compact sources, aperture extraction with background subtraction in both
the BGPS and other data set should be effective.  In Figure \ref{fig:bgsub}, we
show the results of aperture extraction with and without background subtraction
on a simulated power-law image with $\alpha=-1$.  The scatter between the flux density
measurements derived from the input simulated sky map and the iteratively
produced map is very small when background subtraction is used.

In order to compare extended structures, a different approach is required.  The
safest approach is to ``unsharp mask'' (high-pass-filter) both the BGPS and the other data set with a
gaussian kernel with FWHM $\lesssim120\arcsec$ ($\sigma \lesssim 51 \arcsec$).
The filtering will limit the spatial dynamic range, but will provide accurate
results over the angular scales sampled.


% work/bgps_pipeline/bolocat/input_vs_map20_bolocat.py 
\FigureTwo{figures/in_vs_out_bolocat_FLUX_40}{figures/in_vs_out_bolocat_FLUX_120}
{The aperture-extracted flux densities in a simulated map.  The X-axis shows the flux density
of the source in the input map with (blue circles) and without (red squares)
the flux density averaged in a background annulus subtracted.  The black dashed line is the
1-1 line.  The agreement is
excellent for 40\arcsec\ diameter background-subtracted apertures, with RMS(out-in) =
0.06, when background subtraction is used, indicating the utility and necessity
of this approach.  The same relation holds for larger apertures, including the
largest 120\arcsec\ diameter used in bolocat, with slightly more scatter RMS(out-in) =
0.75 and a small systematic bias with the iterative map flux densities
$0.128^{+0.017}_{-0.016}$ too low.  However, the offset is not well-represented
by a multiplicative scaling, so when using the 120\arcsec apertures, one should
include a systematic uncertainty of $\sim5\%$ on top of the simple
multiplicative correction.
}
{fig:bgsub}{1.2}

Direct comparison of power spectra over the reproduced range is also possible.
A demonstration of this approach is given in Figure \ref{fig:higalpowerlaw}.
The BGPS power spectrum has a shape very similar to that of HiGal, and is lower
by a factor consistent with typical dust $\beta$ measurements in the range
$1.5 < \beta < 2$.

% ~/work/bolocam/l030/psd_compare.py
\Figure{figures/l030_higal_bgps_powerspec_compare}
{A comparison of the power spectra of the $\ell=30$ HiGal SDP fields with the
BGPS power spectrum covering the same area.  The range included is 1 square
degree.  The dashed and dotted black lines indicate power laws with $\alpha=-2$
and $\alpha=-1$ respectively, with arbitrary normalizations, as a guide for
comparison.  The vertical dashed red and green lines indicate the large angular
scale 50\% recovery point of the BGPS and the BGPS beam FWHM respectively.
The ratio of 500 \um to 1100 \um in this example has a spectral index
$\alpha\sim3.7$ (with apologies for the symbol clutter).  Note that the 500 \um
power begins falling off more steeply at $\sim40\arcsec$ because the Herschel
FWHM beam size is 36\arcsec, slightly larger than Bolocam's.}
{fig:higalpowerlaw}{0.6}{0}


% \Figure{figures/stfs_bestmodels.png}
% {Simulated spatial transfer function.  The Y-axis shows the fraction of power
% ($P=I_\nu^2$) recovered as a function of spatial scale.  Three sets of
% simulations are shown with different values of the input peak atmospheric power
% and peak astrophysical amplitude.  Only simulations in which measurements of
% the small-scale recovered structure was high were included (those in which the
% astrophysical power law was in the
% range $-1 < \alpha < 0.5$; steeper power spectra had effectively no recovered
% astrophysical emission above the noise level).  The shaded region indicates the
% standard deviation across these different $\alpha$ parameters and is indicative
% of the scatter in the recovery function.
% The agreement between the two simulation sets with the same astrophysical to
% atmospheric peak power ratio indicates that this ratio is the relevant parameter
% when determining large spatial scale recovery; the excess power seen below $f\approx3\ee{3}$
% is from additional atmospheric emission being included in the final map.
% % Is this bad? XXXX
% The spike below 30\arcsec\ is excess power from sub-beam-scale noise and can be
% ignored.}
% {fig:bestmodels}{0.5}{0}
% 
% \Figure{figures/stfs_bestmodel_fits.png}
% {The average of 16 simulated PSD computations and the parametric best-fit.  The
% simulations used had an atmospheric amplitude of 10 Jy and an astrophysical
% amplitude of 1 Jy.}
% {fig:bestmodelfits}{0.5}{0}

%\Figure{figures/airy_test_ds2_reconv_arrang45_atmotest_amp1.0E-02_stf.png}
%{THIS FIGURE PROBABLY NEEDS TO BE UPDATED - code is in place but noise levels aren't synced yet.
%The spatial recovery for a point-source simulation.  The input source is an Airy function, which
%has power at all spatial frequencies.}
%{fig:pointsourcestf}{0.5}{0}

%\begin{equation}
%  FS = FT\{\sqrt{
%\end{equation}

% REMOVE spatial transfer function; just describe limitations
% \subsection{Applying the STF}
% \label{sec:applystf}
% \todo{Determine if this will be done; if not, remove.  }
% \optional{Since the spatial transfer function cannot be represented in real or fourier
% space, it cannot be applied by mathematical operations on images.  We therefore
% provide an interface to the pipeline that allows a user to input any image with
% correct WCS coordinates to be processed through the pipeline in a manner
% identical to the original Bolocam data.   This interface creates an artificial
% bolocam timestream with artificial atmosphere in the same manner as the
% simulations described in Section \ref{sec:atmotests}.  An example of the
% simulated pipeline begin run on real data is given in Section \ref{sec:imcomp}.
% }

\input{solobib}
\end{document}
